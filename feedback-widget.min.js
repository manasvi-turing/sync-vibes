!function(e){"use strict";const n={version:"1.0.0",feedbacks:[],config:{storageKey:"feedback_widget_data",showButton:!0,buttonPosition:"bottom-right",theme:"light",maxCommentLength:500},isActive:!1,currentBox:null,isDrawing:!1,drawStartX:0,drawStartY:0,currentDrawBox:null,markersVisible:!0,init:function(e={}){this.config={...this.config,...e};const n=localStorage.getItem("feedback_markers_visible");return null!==n&&(this.markersVisible="true"===n),this.loadFeedbacks(),this.injectStyles(),this.config.showButton&&this.createToggleButton(),this.setupEventListeners(),this.setupRouteChangeListeners(),this.checkScrollToAnnotation(),this},checkScrollToAnnotation:function(){const e=sessionStorage.getItem("fb_scroll_to_id"),n=sessionStorage.getItem("fb_ensure_visible");e&&(sessionStorage.removeItem("fb_scroll_to_id"),"true"===n&&(sessionStorage.removeItem("fb_ensure_visible"),this.markersVisible=!0,localStorage.setItem("feedback_markers_visible","true")),setTimeout(()=>{if(this.markersVisible){document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display="block"}),this.toggleMarkersButton&&(this.toggleMarkersButton.innerHTML='<span class="material-symbols-outlined">visibility</span>',this.toggleMarkersButton.title="Hide markers")}const n=this.feedbacks.find(n=>n.id===e);n&&this.scrollToAnnotation(n)},500))},injectStyles:function(){if(document.getElementById("feedback-widget-styles"))return;if(!document.getElementById("google-material-symbols")){const e=document.createElement("link");e.id="google-material-symbols",e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200",document.head.appendChild(e)}const e=document.createElement("style");e.id="feedback-widget-styles",e.textContent="\n        .fb-widget-container {\n          position: fixed;\n          z-index: 999999;\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n          background: white;\n          padding: 12px;\n          border-radius: 12px;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        }\n        \n        .fb-widget-container:hover {\n          box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);\n          transform: translateY(-4px) scale(1.03);\n        }\n        \n        .fb-widget-container.bottom-right { bottom: 20px; right: 20px; }\n        .fb-widget-container.bottom-left { bottom: 20px; left: 20px; }\n        .fb-widget-container.top-right { top: 20px; right: 20px; }\n        .fb-widget-container.top-left { top: 20px; left: 20px; }\n        \n        .fb-button-row {\n          display: grid;\n          grid-template-columns: 1fr auto;\n          gap: 8px;\n          align-items: center;\n        }\n        \n        .fb-widget-button {\n          padding: 10px 14px;\n          background: #4F46E5;\n          color: white;\n          border: none;\n          border-radius: 8px;\n          cursor: pointer;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n          font-weight: 500;\n          box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n          transition: all 0.2s;\n          display: inline-flex;\n          align-items: center;\n          justify-content: center;\n          gap: 6px;\n          white-space: nowrap;\n        }\n        \n        .fb-widget-button span:not(.material-symbols-outlined) {\n          min-width: 70px;\n          text-align: center;\n        }\n        \n        .fb-widget-button .material-symbols-outlined {\n          font-size: 20px;\n        }\n        \n        .fb-widget-button:hover {\n          background: #4338CA;\n          transform: translateY(-2px);\n          box-shadow: 0 6px 12px rgba(0,0,0,0.15);\n        }\n        \n        .fb-widget-button.active {\n          background: #DC2626;\n        }\n        \n        .fb-toggle-markers-btn {\n          min-width: 44px;\n          padding: 10px;\n          justify-content: center;\n        }\n        \n        .fb-stats-bar {\n          display: flex;\n          gap: 8px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        }\n        \n        .fb-stat-item {\n          flex: 1;\n          padding: 8px;\n          background: rgba(255, 255, 255, 0.95);\n          border: 1px solid #E5E7EB;\n          border-radius: 6px;\n          text-align: center;\n          display: flex;\n          flex-direction: column;\n          gap: 4px;\n        }\n        \n        .fb-stat-number {\n          color: #4F46E5;\n          font-weight: 700;\n          font-size: 18px;\n          line-height: 1;\n        }\n        \n        .fb-stat-label {\n          color: #6B7280;\n          font-size: 10px;\n          font-weight: 500;\n          text-transform: uppercase;\n          letter-spacing: 0.3px;\n          line-height: 1;\n        }\n        \n        .fb-stat-item:hover {\n          background: #F3F4F6;\n          cursor: pointer;\n          transform: translateY(-1px);\n        }\n        \n        .fb-modal-overlay {\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background: rgba(0, 0, 0, 0.5);\n          z-index: 1000000;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          backdrop-filter: blur(4px);\n        }\n        \n        .fb-modal {\n          background: white;\n          border-radius: 16px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n          max-width: 600px;\n          max-height: 80vh;\n          width: 90%;\n          display: flex;\n          flex-direction: column;\n        }\n        \n        .fb-modal-header {\n          padding: 20px 24px;\n          border-bottom: 1px solid #E5E7EB;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n        \n        .fb-modal-title {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 18px;\n          font-weight: 600;\n          color: #111827;\n        }\n        \n        .fb-modal-close {\n          background: none;\n          border: none;\n          cursor: pointer;\n          padding: 4px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          color: #6B7280;\n          transition: all 0.2s;\n          border-radius: 6px;\n        }\n        \n        .fb-modal-close:hover {\n          background: #F3F4F6;\n          color: #111827;\n        }\n        \n        .fb-modal-body {\n          padding: 16px 24px 24px;\n          overflow-y: auto;\n          flex: 1;\n        }\n        \n        .fb-annotation-item {\n          padding: 16px;\n          border: 1px solid #E5E7EB;\n          border-radius: 10px;\n          margin-bottom: 12px;\n          cursor: pointer;\n          transition: all 0.2s;\n        }\n        \n        .fb-annotation-item:hover {\n          border-color: #4F46E5;\n          box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);\n          transform: translateY(-2px);\n        }\n        \n        .fb-annotation-header {\n          display: flex;\n          align-items: flex-start;\n          gap: 8px;\n          margin-bottom: 10px;\n        }\n        \n        .fb-annotation-icon {\n          color: #4F46E5;\n          font-size: 20px;\n          flex-shrink: 0;\n        }\n        \n        .fb-annotation-meta {\n          flex: 1;\n        }\n        \n        .fb-annotation-page {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 13px;\n          font-weight: 600;\n          color: #4F46E5;\n          margin-bottom: 4px;\n          word-break: break-all;\n        }\n        \n        .fb-annotation-location {\n          font-family: 'Monaco', 'Courier New', monospace;\n          font-size: 11px;\n          color: #6B7280;\n          word-break: break-all;\n        }\n        \n        .fb-annotation-comment {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n          color: #374151;\n          line-height: 1.5;\n          padding-left: 28px;\n        }\n        \n        .fb-empty-state {\n          text-align: center;\n          padding: 40px 20px;\n          color: #9CA3AF;\n        }\n        \n        .fb-empty-state .material-symbols-outlined {\n          font-size: 48px;\n          margin-bottom: 12px;\n          opacity: 0.5;\n        }\n        \n        @keyframes pulse {\n          0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }\n          50% { transform: scale(1.1); box-shadow: 0 8px 24px rgba(79, 70, 229, 0.6); }\n        }\n        \n        .fb-feedback-marker {\n          position: absolute;\n          border: 3px solid #4F46E5;\n          background: rgba(79, 70, 229, 0.1);\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);\n          z-index: 999998;\n          transition: all 0.2s;\n          pointer-events: auto;\n        }\n        \n        .fb-feedback-marker:hover {\n          background: rgba(79, 70, 229, 0.15);\n          box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5);\n          border-color: #4338CA;\n        }\n        \n        .fb-feedback-marker.active {\n          border: 3px solid #10B981;\n          background: rgba(16, 185, 129, 0.15);\n          box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);\n          z-index: 999999;\n        }\n        \n        .fb-feedback-marker.active .fb-feedback-marker-label {\n          background: #10B981;\n        }\n        \n        .fb-feedback-marker-label {\n          position: absolute;\n          top: -12px;\n          left: -12px;\n          min-width: 28px;\n          height: 28px;\n          padding: 0 8px;\n          background: #4F46E5;\n          color: white;\n          border: 2px solid white;\n          border-radius: 6px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 13px;\n          font-weight: bold;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        }\n        \n        .fb-feedback-marker-label::before {\n          content: '#';\n          margin-right: 2px;\n          opacity: 0.9;\n        }\n        \n        .fb-drawing-box {\n          position: absolute;\n          border: 2px dashed #4F46E5;\n          background: rgba(79, 70, 229, 0.08);\n          z-index: 999999;\n          pointer-events: none;\n        }\n        \n        .fb-feedback-box {\n          position: absolute;\n          z-index: 1000000;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 10px 40px rgba(0,0,0,0.2);\n          padding: 20px;\n          width: 320px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          animation: fb-slide-in 0.3s ease-out;\n        }\n        \n        @keyframes fb-slide-in {\n          from { opacity: 0; transform: translateY(10px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n        \n        .fb-feedback-box-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-bottom: 16px;\n        }\n        \n        .fb-feedback-box-title {\n          font-size: 16px;\n          font-weight: 600;\n          color: #1F2937;\n        }\n        \n        .fb-feedback-box-close {\n          background: none;\n          border: none;\n          font-size: 24px;\n          cursor: pointer;\n          color: #6B7280;\n          padding: 0;\n          width: 24px;\n          height: 24px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n        \n        .fb-comments-history {\n          max-height: 250px;\n          overflow-y: auto;\n          margin-bottom: 16px;\n          padding: 12px;\n          background: #F9FAFB;\n          border-radius: 8px;\n        }\n        \n        .fb-comment-item {\n          margin-bottom: 12px;\n          padding: 10px;\n          background: white;\n          border-radius: 6px;\n          border-left: 3px solid #4F46E5;\n        }\n        \n        .fb-comment-item:last-child {\n          margin-bottom: 0;\n        }\n        \n        .fb-comment-time {\n          font-size: 11px;\n          color: #6B7280;\n          margin-bottom: 6px;\n        }\n        \n        .fb-comment-text {\n          font-size: 14px;\n          color: #1F2937;\n          line-height: 1.5;\n          word-wrap: break-word;\n        }\n        \n        .fb-no-comments {\n          text-align: center;\n          color: #9CA3AF;\n          font-size: 13px;\n          padding: 20px;\n        }\n        \n        .fb-feedback-textarea {\n          width: 100%;\n          min-height: 80px;\n          padding: 12px;\n          border: 1px solid #D1D5DB;\n          border-radius: 8px;\n          font-family: inherit;\n          font-size: 14px;\n          resize: vertical;\n          box-sizing: border-box;\n        }\n        \n        .fb-feedback-textarea:focus {\n          outline: none;\n          border-color: #4F46E5;\n          box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);\n        }\n        \n        .fb-feedback-actions {\n          display: flex;\n          flex-wrap: wrap;\n          gap: 8px;\n          margin-top: 12px;\n        }\n        \n        .fb-feedback-btn {\n          flex: 1;\n          padding: 10px;\n          border: none;\n          border-radius: 6px;\n          font-size: 14px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.2s;\n          min-width: 0;\n        }\n        \n        .fb-feedback-btn.fb-feedback-btn-danger {\n          flex-basis: 100%;\n          order: 3;\n        }\n        \n        .fb-feedback-btn-primary {\n          background: #4F46E5;\n          color: white;\n        }\n        \n        .fb-feedback-btn-primary:hover {\n          background: #4338CA;\n        }\n        \n        .fb-feedback-btn-secondary {\n          background: #F3F4F6;\n          color: #374151;\n        }\n        \n        .fb-feedback-btn-secondary:hover {\n          background: #E5E7EB;\n        }\n        \n        .fb-feedback-btn-danger {\n          background: #EF4444;\n          color: white;\n          display: flex;\n          align-items: center;\n          gap: 4px;\n          justify-content: center;\n        }\n        \n        .fb-feedback-btn-danger:hover {\n          background: #DC2626;\n        }\n        \n        .fb-feedback-list {\n          position: fixed;\n          right: 20px;\n          top: 20px;\n          z-index: 999997;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 10px 40px rgba(0,0,0,0.2);\n          padding: 16px;\n          width: 280px;\n          max-height: 400px;\n          overflow-y: auto;\n        }\n        \n        .fb-feedback-item {\n          padding: 12px;\n          background: #F9FAFB;\n          border-radius: 8px;\n          margin-bottom: 8px;\n          font-size: 13px;\n        }\n        \n        .fb-feedback-item-text {\n          color: #374151;\n          margin-bottom: 4px;\n        }\n        \n        .fb-feedback-item-meta {\n          color: #9CA3AF;\n          font-size: 11px;\n        }\n        \n        .fb-viewport-warning {\n          position: fixed;\n          top: 80px;\n          left: 50%;\n          transform: translateX(-50%);\n          z-index: 1000001;\n          max-width: 600px;\n          width: 90%;\n          animation: fb-slide-in 0.3s ease-out;\n        }\n        \n        .fb-viewport-warning-content {\n          background: white;\n          border: 2px solid #F59E0B;\n          border-radius: 16px;\n          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n          overflow: hidden;\n        }\n        \n        .fb-viewport-warning-header {\n          background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);\n          padding: 16px 20px;\n          display: flex;\n          align-items: center;\n          gap: 12px;\n          color: white;\n        }\n        \n        .fb-viewport-warning-header strong {\n          flex: 1;\n          font-size: 16px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        }\n        \n        .fb-viewport-warning-icon {\n          font-size: 24px;\n        }\n        \n        .fb-viewport-warning-body {\n          padding: 20px;\n        }\n        \n        .fb-viewport-metric {\n          margin-bottom: 20px;\n          padding-bottom: 20px;\n          border-bottom: 1px solid #E5E7EB;\n        }\n        \n        .fb-viewport-metric:last-of-type {\n          border-bottom: none;\n          margin-bottom: 0;\n          padding-bottom: 0;\n        }\n        \n        .fb-viewport-metric-label {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          font-weight: 600;\n          color: #374151;\n          margin-bottom: 12px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n        }\n        \n        .fb-viewport-metric-label .material-symbols-outlined {\n          font-size: 20px;\n          color: #6B7280;\n        }\n        \n        .fb-viewport-metric-values {\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n          color: #6B7280;\n          padding-left: 28px;\n        }\n        \n        .fb-viewport-metric-values strong {\n          color: #111827;\n          font-family: 'Monaco', 'Courier New', monospace;\n        }\n        \n        .fb-status-badge {\n          display: inline-flex;\n          align-items: center;\n          justify-content: center;\n          width: 24px;\n          height: 24px;\n          border-radius: 50%;\n          font-weight: bold;\n          font-size: 14px;\n          margin-left: 8px;\n          transition: all 0.3s;\n        }\n        \n        .fb-status-badge.fb-status-ok {\n          background: #10B981;\n          color: white;\n        }\n        \n        .fb-status-badge.fb-status-error {\n          background: #EF4444;\n          color: white;\n        }\n        \n        .fb-viewport-warning-hint {\n          display: flex;\n          align-items: flex-start;\n          gap: 8px;\n          background: #F3F4F6;\n          padding: 12px;\n          border-radius: 8px;\n          font-size: 13px;\n          color: #6B7280;\n          line-height: 1.5;\n          margin-top: 16px;\n        }\n        \n        .fb-viewport-warning-hint .material-symbols-outlined {\n          font-size: 20px;\n          color: #9CA3AF;\n          flex-shrink: 0;\n        }\n      ",document.head.appendChild(e)},createToggleButton:function(){const e=document.createElement("div");e.className=`fb-widget-container ${this.config.buttonPosition}`;const n=document.createElement("div");n.className="fb-button-row";const t=document.createElement("button");t.className="fb-widget-button",t.innerHTML='<span class="material-symbols-outlined">chat</span><span>SyncVibes</span>',t.onclick=()=>this.toggleMode(),n.appendChild(t),this.toggleButton=t;const o=document.createElement("button");o.className="fb-widget-button fb-toggle-markers-btn",o.innerHTML=this.markersVisible?'<span class="material-symbols-outlined">visibility</span>':'<span class="material-symbols-outlined">visibility_off</span>',o.title=this.markersVisible?"Hide markers":"Show markers",o.onclick=()=>this.toggleMarkers(),n.appendChild(o),this.toggleMarkersButton=o,e.appendChild(n);const i=document.createElement("div");i.className="fb-stats-bar",i.innerHTML='\n        <div class="fb-stat-item">\n          <div class="fb-stat-number" id="fb-stat-page">0</div>\n          <div class="fb-stat-label">This Page</div>\n        </div>\n        <div class="fb-stat-item">\n          <div class="fb-stat-number" id="fb-stat-total">0</div>\n          <div class="fb-stat-label">Total</div>\n        </div>\n      ',e.appendChild(i),this.statsBar=i;const a=i.children[0],s=i.children[1];a.addEventListener("click",()=>{this.openAnnotationsModal("page")}),s.addEventListener("click",()=>{this.openAnnotationsModal("total")}),document.body.appendChild(e),this.widgetContainer=e,this.updateStats()},toggleMode:function(){if(this.isActive=!this.isActive,this.toggleButton.classList.toggle("active",this.isActive),this.toggleButton.innerHTML=this.isActive?'<span class="material-symbols-outlined">close</span><span>Close</span>':'<span class="material-symbols-outlined">chat</span><span>SyncVibes</span>',this.isActive&&!this.markersVisible){this.markersVisible=!0;document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display="block"}),this.toggleMarkersButton.innerHTML='<span class="material-symbols-outlined">visibility</span>',this.toggleMarkersButton.title="Hide markers",localStorage.setItem("feedback_markers_visible","true")}this.isActive?(document.body.style.cursor="crosshair",document.body.style.userSelect="none"):(document.body.style.cursor="",document.body.style.userSelect=""),!this.isActive&&this.currentBox&&this.closeCurrentBox()},toggleMarkers:function(){this.markersVisible=!this.markersVisible;document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display=this.markersVisible?"block":"none"}),this.toggleMarkersButton.innerHTML=this.markersVisible?'<span class="material-symbols-outlined">visibility</span>':'<span class="material-symbols-outlined">visibility_off</span>',this.toggleMarkersButton.title=this.markersVisible?"Hide markers":"Show markers",localStorage.setItem("feedback_markers_visible",this.markersVisible.toString())},updateStats:function(){const n=document.getElementById("fb-stat-page"),t=document.getElementById("fb-stat-total");if(!n||!t)return;const o=this.feedbacks.length,i=e.location.href,a=e.location.pathname,s=e.location.hash,r=this.feedbacks.filter(n=>{try{const t=new URL(n.url,e.location.origin);return n.url===i||(t.pathname===a&&t.hash===s||t.pathname===a&&!s&&!t.hash)}catch(e){return n.pathname===a}}).length;n.textContent=r,t.textContent=o},openAnnotationsModal:function(n){const t=e.location.href,o=e.location.pathname,i=e.location.hash;let a=[];a="page"===n?this.feedbacks.filter(n=>{try{const a=new URL(n.url,e.location.origin);return n.url===t||(a.pathname===o&&a.hash===i||a.pathname===o&&!i&&!a.hash)}catch(e){return n.pathname===o}}):this.feedbacks;const s=document.createElement("div");s.className="fb-modal-overlay";const r=document.createElement("div");r.className="fb-modal";const c=document.createElement("div");c.className="fb-modal-header";const l=document.createElement("div");l.className="fb-modal-title",l.innerHTML=`<span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">bookmark</span>${"page"===n?"This Page":"All"} Annotations (${a.length})`;const d=document.createElement("button");d.className="fb-modal-close",d.innerHTML='<span class="material-symbols-outlined">close</span>',d.title="Close",c.appendChild(l),c.appendChild(d);const b=document.createElement("div");b.className="fb-modal-body",0===a.length?b.innerHTML='\n          <div class="fb-empty-state">\n            <span class="material-symbols-outlined">sentiment_satisfied</span>\n            <div>No annotations yet</div>\n          </div>\n        ':a.forEach(n=>{const t=document.createElement("div");t.className="fb-annotation-item";let o="Unknown",i="";try{const t=new URL(n.url,e.location.origin);o=t.pathname,i=t.hash}catch(e){o=n.pathname||"Unknown"}t.innerHTML=`\n            <div class="fb-annotation-header">\n              <span class="material-symbols-outlined fb-annotation-icon">location_on</span>\n              <div class="fb-annotation-meta">\n                <div class="fb-annotation-page">${o}</div>\n                <div class="fb-annotation-location">${i||"Top of page"} • (${n.x}, ${n.y})</div>\n              </div>\n            </div>\n            <div class="fb-annotation-comment">${n.comment}</div>\n          `,t.addEventListener("click",()=>{this.navigateToAnnotation(n),this.closeModal(s)}),b.appendChild(t)}),r.appendChild(c),r.appendChild(b),s.appendChild(r),d.addEventListener("click",()=>this.closeModal(s)),s.addEventListener("click",e=>{e.target===s&&this.closeModal(s)}),document.body.appendChild(s)},closeModal:function(e){e.remove()},navigateToAnnotation:function(n){if(!this.markersVisible){this.markersVisible=!0;document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display="block"}),this.toggleMarkersButton&&(this.toggleMarkersButton.innerHTML='<span class="material-symbols-outlined">visibility</span>',this.toggleMarkersButton.title="Hide markers"),localStorage.setItem("feedback_markers_visible","true")}const t=e.location.href;n.url!==t?(sessionStorage.setItem("fb_scroll_to_id",n.id),sessionStorage.setItem("fb_ensure_visible","true"),e.location.href=n.url):this.scrollToAnnotation(n)},scrollToAnnotation:function(n){const t=document.querySelector(`[data-feedback-id="${n.id}"]`);t?(t.style.display="block",t.scrollIntoView({behavior:"smooth",block:"center"}),t.style.animation="none",setTimeout(()=>{t.style.animation="pulse 1s ease-in-out 3"},10)):e.scrollTo({top:n.position.pageY-e.innerHeight/2,left:n.position.pageX-e.innerWidth/2,behavior:"smooth"})},setupEventListeners:function(){document.addEventListener("selectstart",e=>{this.isActive&&e.preventDefault()}),document.addEventListener("mousemove",e=>{this.isActive?(document.body.style.cursor="crosshair",document.body.style.userSelect="none",this.isDrawing&&this.currentDrawBox&&this.updateDrawingBox(e.pageX,e.pageY)):(document.body.style.cursor="",document.body.style.userSelect="")}),document.addEventListener("mousedown",e=>{this.isActive&&(e.target.closest(".fb-widget-button")||e.target.closest(".fb-feedback-box")||e.target.closest(".fb-feedback-marker")||(e.preventDefault(),e.stopPropagation(),this.startDrawing(e.pageX,e.pageY)))},!0),document.addEventListener("mouseup",e=>{this.isActive&&this.isDrawing&&(e.preventDefault(),e.stopPropagation(),this.finishDrawing(e.pageX,e.pageY))},!0)},setupRouteChangeListeners:function(){e.addEventListener("popstate",()=>{this.handleRouteChange()});const n=history.pushState,t=history.replaceState,o=this;let i;history.pushState=function(){n.apply(this,arguments),o.handleRouteChange()},history.replaceState=function(){t.apply(this,arguments),o.handleRouteChange()},e.addEventListener("hashchange",()=>{this.handleRouteChange()}),e.addEventListener("resize",()=>{clearTimeout(i),i=setTimeout(()=>{this.recheckViewportMismatch()},300)})},handleRouteChange:function(){console.log("Route changed to:",e.location.pathname),this.displayMarkersForCurrentPage(),this.currentBox&&this.closeCurrentBox(),this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null),this.isActive&&(this.isActive=!1,this.toggleButton.classList.remove("active"),this.toggleButton.textContent="💬 Feedback",document.body.style.cursor="",document.body.style.userSelect="")},startDrawing:function(e,n){this.isDrawing=!0,this.drawStartX=e,this.drawStartY=n;const t=document.createElement("div");t.className="fb-drawing-box",t.style.left=`${e}px`,t.style.top=`${n}px`,t.style.width="0px",t.style.height="0px",document.body.appendChild(t),this.currentDrawBox=t},updateDrawingBox:function(e,n){if(!this.currentDrawBox)return;const t=Math.min(this.drawStartX,e),o=Math.min(this.drawStartY,n),i=Math.abs(e-this.drawStartX),a=Math.abs(n-this.drawStartY);this.currentDrawBox.style.left=`${t}px`,this.currentDrawBox.style.top=`${o}px`,this.currentDrawBox.style.width=`${i}px`,this.currentDrawBox.style.height=`${a}px`},finishDrawing:function(e,n){this.isDrawing=!1;const t=Math.min(this.drawStartX,e),o=Math.min(this.drawStartY,n),i=Math.abs(e-this.drawStartX),a=Math.abs(n-this.drawStartY);if(i<10||a<10)return this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null),void this.createFeedbackBox(this.drawStartX,this.drawStartY,100,100);this.createFeedbackBox(t,o,i,a)},createFeedbackBox:function(e,n,t,o){this.closeCurrentBox();const i=document.createElement("div");i.className="fb-feedback-box",i.style.left=`${e+t+10}px`,i.style.top=`${n}px`,i.innerHTML=`\n        <div class="fb-feedback-box-header">\n          <div class="fb-feedback-box-title">Add Feedback</div>\n          <button class="fb-feedback-box-close">×</button>\n        </div>\n        <textarea \n          class="fb-feedback-textarea" \n          placeholder="What's on your mind?"\n          maxlength="${this.config.maxCommentLength}"\n        ></textarea>\n        <div class="fb-feedback-actions">\n          <button class="fb-feedback-btn fb-feedback-btn-secondary">Cancel</button>\n          <button class="fb-feedback-btn fb-feedback-btn-primary">Save</button>\n        </div>\n      `,document.body.appendChild(i),this.currentBox={element:i,x:e,y:n,width:t,height:o};const a=i.querySelector(".fb-feedback-textarea");a.focus(),i.querySelector(".fb-feedback-box-close").onclick=()=>this.cancelFeedback(),i.querySelector(".fb-feedback-btn-secondary").onclick=()=>this.cancelFeedback(),i.querySelector(".fb-feedback-btn-primary").onclick=()=>this.saveFeedback(a.value,e,n,t,o);const s=e=>{"Escape"===e.key&&(this.cancelFeedback(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s),i._escapeHandler=s},cancelFeedback:function(){this.closeCurrentBox(),this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null)},saveFeedback:function(n,t,o,i,a){if(!n.trim())return void alert("Please enter a comment");const s=this.generateId(),r=Date.now(),c={id:s,comment:n.trim(),comments:[{text:n.trim(),timestamp:r}],position:{x:t,y:o,width:i,height:a,pageX:t,pageY:o,viewportWidth:e.innerWidth,viewportHeight:e.innerHeight,scrollX:e.scrollX,scrollY:e.scrollY},url:e.location.href,pathname:e.location.pathname,timestamp:new Date(r).toISOString(),userAgent:navigator.userAgent,screenSize:{width:e.screen.width,height:e.screen.height}};this.feedbacks.push(c),this.saveFeedbacks(),this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null),this.createMarker(c),this.closeCurrentBox(),this.updateStats(),console.log("Feedback saved:",c)},createMarker:function(e){const n=document.createElement("div");n.className="fb-feedback-marker";const t=this.feedbacks.indexOf(e)+1;n.style.left=`${e.position.pageX}px`,n.style.top=`${e.position.pageY}px`,n.style.width=`${e.position.width}px`,n.style.height=`${e.position.height}px`,n.style.display=this.markersVisible?"block":"none",n.dataset.feedbackId=e.id;const o=document.createElement("div");o.className="fb-feedback-marker-label",o.textContent=t,n.appendChild(o),n.onclick=n=>{n.stopPropagation(),this.showFeedback(e)},document.body.appendChild(n),this.updateMarkerTooltip(e.id),console.log("Created marker #"+t+" at:",{left:n.style.left,top:n.style.top,width:n.style.width,height:n.style.height})},showFeedback:function(n){this.closeCurrentBox();const t=document.querySelector(`[data-feedback-id="${n.id}"]`);t&&t.classList.add("active");const o=document.createElement("div");o.className="fb-feedback-box";const i=t?.getBoundingClientRect();i?(o.style.left=`${i.right+e.scrollX+10}px`,o.style.top=`${i.top+e.scrollY}px`):(o.style.left=`${n.position.pageX+n.position.width+10}px`,o.style.top=`${n.position.pageY}px`);let a="";n.comments&&n.comments.length>0&&(a=n.comments.map(e=>`\n          <div class="fb-comment-item">\n            <div class="fb-comment-time">${new Date(e.timestamp).toLocaleString()}</div>\n            <div class="fb-comment-text">${this.escapeHtml(e.text)}</div>\n          </div>\n        `).join("")),o.innerHTML=`\n        <div class="fb-feedback-box-header">\n          <div class="fb-feedback-box-title">\n            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">chat</span>\n            Annotation #${this.feedbacks.indexOf(n)+1}\n          </div>\n          <button class="fb-feedback-box-close">×</button>\n        </div>\n        <div class="fb-comments-history">\n          ${a||'<div class="fb-no-comments">No comments yet</div>'}\n        </div>\n        <textarea \n          class="fb-feedback-textarea" \n          placeholder="Add a comment..."\n          maxlength="${this.config.maxCommentLength}"\n        ></textarea>\n        <div class="fb-feedback-actions">\n          <button class="fb-feedback-btn fb-feedback-btn-danger">\n            <span class="material-symbols-outlined" style="font-size: 16px;">delete</span>\n            Delete\n          </button>\n          <button class="fb-feedback-btn fb-feedback-btn-secondary">Close</button>\n          <button class="fb-feedback-btn fb-feedback-btn-primary">Add Comment</button>\n        </div>\n      `,document.body.appendChild(o),this.currentBox={element:o,feedback:n,marker:t};const s=o.querySelector(".fb-feedback-textarea");s.focus(),o.querySelector(".fb-feedback-box-close").onclick=()=>this.closeCurrentBox(),o.querySelector(".fb-feedback-btn-secondary").onclick=()=>this.closeCurrentBox(),o.querySelector(".fb-feedback-btn-danger").onclick=()=>{confirm("Are you sure you want to delete this annotation and all its comments?")&&this.deleteAnnotation(n.id)},o.querySelector(".fb-feedback-btn-primary").onclick=()=>{const e=s.value.trim();e?(this.addCommentToFeedback(n.id,e),this.closeCurrentBox()):alert("Please enter a comment")};const r=e=>{"Escape"===e.key&&(this.closeCurrentBox(),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r),o._escapeHandler=r},addCommentToFeedback:function(e,n){const t=this.feedbacks.find(n=>n.id===e);t&&(t.comments||(t.comments=[],t.comment&&t.comments.push({text:t.comment,timestamp:t.timestamp})),t.comments.push({text:n,timestamp:Date.now()}),this.saveFeedbacks(),this.updateMarkerTooltip(e),console.log("Added comment to feedback #"+e))},updateMarkerTooltip:function(e){const n=this.feedbacks.find(n=>n.id===e);if(!n)return;const t=document.querySelector(`[data-feedback-id="${e}"]`);if(!t)return;const o=(n.comments||(n.comment?[{text:n.comment,timestamp:n.timestamp}]:[])).map((e,n)=>`${n+1}. ${e.text} (${new Date(e.timestamp).toLocaleString()})`).join("\n\n");t.title=o||"No comments"},deleteAnnotation:function(e){const n=this.feedbacks.findIndex(n=>n.id===e);if(-1===n)return;this.feedbacks.splice(n,1);const t=document.querySelector(`[data-feedback-id="${e}"]`);t&&t.remove(),this.closeCurrentBox(),this.saveFeedbacks(),this.updateStats(),console.log("Deleted annotation #"+e)},escapeHtml:function(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML},closeCurrentBox:function(){this.currentBox&&(this.currentBox.element._escapeHandler&&document.removeEventListener("keydown",this.currentBox.element._escapeHandler),this.currentBox.marker&&this.currentBox.marker.classList.remove("active"),this.currentBox.element.remove(),this.currentBox=null)},saveFeedbacks:function(){try{localStorage.setItem(this.config.storageKey,JSON.stringify(this.feedbacks))}catch(e){console.error("Failed to save feedbacks:",e)}},loadFeedbacks:function(){try{const e=localStorage.getItem(this.config.storageKey);e&&(this.feedbacks=JSON.parse(e),this.displayMarkersForCurrentPage())}catch(e){console.error("Failed to load feedbacks:",e)}},displayMarkersForCurrentPage:function(){this.clearMarkers();const n=e.location.href,t=e.location.pathname,o=e.location.hash,i=this.feedbacks.filter(i=>{try{const a=new URL(i.url,e.location.origin);return i.url===n||(a.pathname===t&&a.hash===o||a.pathname===t&&!o&&!a.hash)}catch(e){return i.pathname===t}});i.forEach(e=>this.createMarker(e)),this.updateStats(),this.checkViewportMismatch(i),console.log(`Displayed ${i.length} markers for ${t}${o}`)},checkViewportMismatch:function(n){if(!n||0===n.length)return void this.hideViewportWarning();const t=n.map(e=>e.position).filter(e=>e&&e.viewportWidth&&e.viewportHeight);if(0===t.length)return void this.hideViewportWarning();const o=t[0],i=e.innerWidth,a=e.innerHeight,s=Math.abs(i-o.viewportWidth),r=Math.abs(a-o.viewportHeight);s>100||r>100?this.showViewportWarning(o.viewportWidth,o.viewportHeight):this.hideViewportWarning()},showViewportWarning:function(n,t){this.hideViewportWarning();const o=document.createElement("div");o.id="fb-viewport-warning",o.className="fb-viewport-warning",o.innerHTML=`\n        <div class="fb-viewport-warning-content">\n          <div class="fb-viewport-warning-header">\n            <span class="material-symbols-outlined fb-viewport-warning-icon">tune</span>\n            <strong>Display Mismatch Detected</strong>\n          </div>\n          <div class="fb-viewport-warning-body">\n            <div class="fb-viewport-metric">\n              <div class="fb-viewport-metric-label">\n                <span class="material-symbols-outlined">aspect_ratio</span>\n                Viewport Size\n              </div>\n              <div class="fb-viewport-metric-values">\n                <div>Expected: <strong>${n}×${t}</strong></div>\n                <div>Current: <strong id="fb-current-viewport">${e.innerWidth}×${e.innerHeight}</strong> <span id="fb-viewport-status" class="fb-status-badge fb-status-error">✗</span></div>\n              </div>\n            </div>\n            <div class="fb-viewport-metric">\n              <div class="fb-viewport-metric-label">\n                <span class="material-symbols-outlined">zoom_in</span>\n                Browser Zoom\n              </div>\n              <div class="fb-viewport-metric-values">\n                <div>Expected: <strong>100%</strong></div>\n                <div>Current: <strong id="fb-current-zoom">100%</strong> <span id="fb-zoom-status" class="fb-status-badge fb-status-ok">✓</span></div>\n              </div>\n            </div>\n            <div class="fb-viewport-metric">\n              <div class="fb-viewport-metric-label">\n                <span class="material-symbols-outlined">format_size</span>\n                Font Size\n              </div>\n              <div class="fb-viewport-metric-values">\n                <div>Expected: <strong>16px</strong></div>\n                <div>Current: <strong id="fb-current-fontsize">16px</strong> <span id="fb-fontsize-status" class="fb-status-badge fb-status-ok">✓</span></div>\n              </div>\n            </div>\n            <div class="fb-viewport-warning-hint">\n              <span class="material-symbols-outlined">info</span>\n              Adjust your window size and browser zoom to match the expected values. Indicators will turn green when fixed.\n            </div>\n          </div>\n        </div>\n      `,document.body.appendChild(o),this._originalViewport={width:n,height:t},this.startViewportMonitoring()},startViewportMonitoring:function(){this._viewportMonitorInterval&&clearInterval(this._viewportMonitorInterval),this._viewportMonitorInterval=setInterval(()=>{document.getElementById("fb-viewport-warning")?this.updateViewportMetrics():this.stopViewportMonitoring()},200)},stopViewportMonitoring:function(){this._viewportMonitorInterval&&(clearInterval(this._viewportMonitorInterval),this._viewportMonitorInterval=null)},updateViewportMetrics:function(){const n=document.getElementById("fb-current-viewport"),t=document.getElementById("fb-viewport-status"),o=document.getElementById("fb-current-zoom"),i=document.getElementById("fb-zoom-status"),a=document.getElementById("fb-current-fontsize"),s=document.getElementById("fb-fontsize-status");if(!n)return;const r=e.innerWidth,c=e.innerHeight;n.textContent=`${r}×${c}`;const l=Math.abs(r-this._originalViewport.width)<=20&&Math.abs(c-this._originalViewport.height)<=20;t.textContent=l?"✓":"✗",t.className="fb-status-badge "+(l?"fb-status-ok":"fb-status-error");const d=Math.round(100*e.devicePixelRatio);o.textContent=`${d}%`;const b=100===d;i.textContent=b?"✓":"✗",i.className="fb-status-badge "+(b?"fb-status-ok":"fb-status-error");const p=parseFloat(getComputedStyle(document.documentElement).fontSize);a.textContent=`${Math.round(p)}px`;const m=Math.abs(p-16)<=2;s.textContent=m?"✓":"✗",s.className="fb-status-badge "+(m?"fb-status-ok":"fb-status-error"),l&&b&&m&&setTimeout(()=>{this.hideViewportWarning()},2e3)},recheckViewportMismatch:function(){const n=e.location.href,t=e.location.pathname,o=e.location.hash,i=this.feedbacks.filter(i=>{try{const a=new URL(i.url,e.location.origin);return i.url===n||(a.pathname===t&&a.hash===o||a.pathname===t&&!o&&!a.hash)}catch(e){return i.pathname===t}});i.length>0&&this.checkViewportMismatch(i)},hideViewportWarning:function(){this.stopViewportMonitoring();const e=document.getElementById("fb-viewport-warning");e&&e.remove()},clearMarkers:function(){document.querySelectorAll(".fb-feedback-marker").forEach(e=>e.remove())},exportFeedbacks:function(){return JSON.parse(JSON.stringify(this.feedbacks))},importFeedbacks:function(e){this.feedbacks=e,this.saveFeedbacks(),this.displayMarkersForCurrentPage()},clearFeedbacks:function(){confirm("Clear all feedbacks?")&&(this.feedbacks=[],this.saveFeedbacks(),this.clearMarkers(),this.updateStats())},generateId:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}};e.FeedbackWidget=n}(window);