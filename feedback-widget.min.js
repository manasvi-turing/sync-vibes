!function(e){"use strict";const t={version:"1.0.0",feedbacks:[],config:{storageKey:"feedback_widget_data",showButton:!0,buttonPosition:"bottom-right",theme:"light",maxCommentLength:500},isActive:!1,currentBox:null,isDrawing:!1,drawStartX:0,drawStartY:0,currentDrawBox:null,markersVisible:!0,init:function(e={}){this.config={...this.config,...e};const t=localStorage.getItem("feedback_markers_visible");return null!==t&&(this.markersVisible="true"===t),this.loadFeedbacks(),this.injectStyles(),this.config.showButton&&this.createToggleButton(),this.setupEventListeners(),this.setupRouteChangeListeners(),this.checkScrollToAnnotation(),this},checkScrollToAnnotation:function(){const e=sessionStorage.getItem("fb_scroll_to_id"),t=sessionStorage.getItem("fb_ensure_visible");e&&(sessionStorage.removeItem("fb_scroll_to_id"),"true"===t&&(sessionStorage.removeItem("fb_ensure_visible"),this.markersVisible=!0,localStorage.setItem("feedback_markers_visible","true")),setTimeout(()=>{if(this.markersVisible){document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display="block"}),this.toggleMarkersButton&&(this.toggleMarkersButton.innerHTML='<span class="material-symbols-outlined">visibility</span>',this.toggleMarkersButton.title="Hide markers")}const t=this.feedbacks.find(t=>t.id===e);t&&this.scrollToAnnotation(t)},500))},injectStyles:function(){if(document.getElementById("feedback-widget-styles"))return;if(!document.getElementById("google-material-symbols")){const e=document.createElement("link");e.id="google-material-symbols",e.rel="stylesheet",e.href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200",document.head.appendChild(e)}const e=document.createElement("style");e.id="feedback-widget-styles",e.textContent="\n        .fb-widget-container {\n          position: fixed;\n          z-index: 999999;\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n          background: white;\n          padding: 12px;\n          border-radius: 12px;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        }\n        \n        .fb-widget-container:hover {\n          box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);\n          transform: translateY(-4px) scale(1.03);\n        }\n        \n        .fb-widget-container.bottom-right { bottom: 20px; right: 20px; }\n        .fb-widget-container.bottom-left { bottom: 20px; left: 20px; }\n        .fb-widget-container.top-right { top: 20px; right: 20px; }\n        .fb-widget-container.top-left { top: 20px; left: 20px; }\n        \n        .fb-button-row {\n          display: grid;\n          grid-template-columns: 1fr auto;\n          gap: 8px;\n          align-items: center;\n        }\n        \n        .fb-widget-button {\n          padding: 10px 14px;\n          background: #4F46E5;\n          color: white;\n          border: none;\n          border-radius: 8px;\n          cursor: pointer;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n          font-weight: 500;\n          box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n          transition: all 0.2s;\n          display: inline-flex;\n          align-items: center;\n          justify-content: center;\n          gap: 6px;\n          white-space: nowrap;\n        }\n        \n        .fb-widget-button span:not(.material-symbols-outlined) {\n          min-width: 70px;\n          text-align: center;\n        }\n        \n        .fb-widget-button .material-symbols-outlined {\n          font-size: 20px;\n        }\n        \n        .fb-widget-button:hover {\n          background: #4338CA;\n          transform: translateY(-2px);\n          box-shadow: 0 6px 12px rgba(0,0,0,0.15);\n        }\n        \n        .fb-widget-button.active {\n          background: #DC2626;\n        }\n        \n        .fb-toggle-markers-btn {\n          min-width: 44px;\n          padding: 10px;\n          justify-content: center;\n        }\n        \n        .fb-stats-bar {\n          display: flex;\n          gap: 8px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        }\n        \n        .fb-stat-item {\n          flex: 1;\n          padding: 8px;\n          background: rgba(255, 255, 255, 0.95);\n          border: 1px solid #E5E7EB;\n          border-radius: 6px;\n          text-align: center;\n          display: flex;\n          flex-direction: column;\n          gap: 4px;\n        }\n        \n        .fb-stat-number {\n          color: #4F46E5;\n          font-weight: 700;\n          font-size: 18px;\n          line-height: 1;\n        }\n        \n        .fb-stat-label {\n          color: #6B7280;\n          font-size: 10px;\n          font-weight: 500;\n          text-transform: uppercase;\n          letter-spacing: 0.3px;\n          line-height: 1;\n        }\n        \n        .fb-stat-item:hover {\n          background: #F3F4F6;\n          cursor: pointer;\n          transform: translateY(-1px);\n        }\n        \n        .fb-modal-overlay {\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background: rgba(0, 0, 0, 0.5);\n          z-index: 1000000;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          backdrop-filter: blur(4px);\n        }\n        \n        .fb-modal {\n          background: white;\n          border-radius: 16px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n          max-width: 600px;\n          max-height: 80vh;\n          width: 90%;\n          display: flex;\n          flex-direction: column;\n        }\n        \n        .fb-modal-header {\n          padding: 20px 24px;\n          border-bottom: 1px solid #E5E7EB;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n        \n        .fb-modal-title {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 18px;\n          font-weight: 600;\n          color: #111827;\n        }\n        \n        .fb-modal-close {\n          background: none;\n          border: none;\n          cursor: pointer;\n          padding: 4px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          color: #6B7280;\n          transition: all 0.2s;\n          border-radius: 6px;\n        }\n        \n        .fb-modal-close:hover {\n          background: #F3F4F6;\n          color: #111827;\n        }\n        \n        .fb-modal-body {\n          padding: 16px 24px 24px;\n          overflow-y: auto;\n          flex: 1;\n        }\n        \n        .fb-annotation-item {\n          padding: 16px;\n          border: 1px solid #E5E7EB;\n          border-radius: 10px;\n          margin-bottom: 12px;\n          cursor: pointer;\n          transition: all 0.2s;\n        }\n        \n        .fb-annotation-item:hover {\n          border-color: #4F46E5;\n          box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);\n          transform: translateY(-2px);\n        }\n        \n        .fb-annotation-header {\n          display: flex;\n          align-items: flex-start;\n          gap: 8px;\n          margin-bottom: 10px;\n        }\n        \n        .fb-annotation-icon {\n          color: #4F46E5;\n          font-size: 20px;\n          flex-shrink: 0;\n        }\n        \n        .fb-annotation-meta {\n          flex: 1;\n        }\n        \n        .fb-annotation-page {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 13px;\n          font-weight: 600;\n          color: #4F46E5;\n          margin-bottom: 4px;\n          word-break: break-all;\n        }\n        \n        .fb-annotation-location {\n          font-family: 'Monaco', 'Courier New', monospace;\n          font-size: 11px;\n          color: #6B7280;\n          word-break: break-all;\n        }\n        \n        .fb-annotation-comment {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n          color: #374151;\n          line-height: 1.5;\n          padding-left: 28px;\n        }\n        \n        .fb-empty-state {\n          text-align: center;\n          padding: 40px 20px;\n          color: #9CA3AF;\n        }\n        \n        .fb-empty-state .material-symbols-outlined {\n          font-size: 48px;\n          margin-bottom: 12px;\n          opacity: 0.5;\n        }\n        \n        @keyframes pulse {\n          0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }\n          50% { transform: scale(1.1); box-shadow: 0 8px 24px rgba(79, 70, 229, 0.6); }\n        }\n        \n        .fb-feedback-marker {\n          position: absolute;\n          border: 3px solid #4F46E5;\n          background: rgba(79, 70, 229, 0.1);\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);\n          z-index: 999998;\n          transition: all 0.2s;\n          pointer-events: auto;\n        }\n        \n        .fb-feedback-marker:hover {\n          background: rgba(79, 70, 229, 0.15);\n          box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5);\n          border-color: #4338CA;\n        }\n        \n        .fb-feedback-marker.active {\n          border: 3px solid #10B981;\n          background: rgba(16, 185, 129, 0.15);\n          box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);\n          z-index: 999999;\n        }\n        \n        .fb-feedback-marker.active .fb-feedback-marker-label {\n          background: #10B981;\n        }\n        \n        .fb-feedback-marker-label {\n          position: absolute;\n          top: -12px;\n          left: -12px;\n          min-width: 28px;\n          height: 28px;\n          padding: 0 8px;\n          background: #4F46E5;\n          color: white;\n          border: 2px solid white;\n          border-radius: 6px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          font-size: 13px;\n          font-weight: bold;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        }\n        \n        .fb-feedback-marker-label::before {\n          content: '#';\n          margin-right: 2px;\n          opacity: 0.9;\n        }\n        \n        .fb-drawing-box {\n          position: absolute;\n          border: 2px dashed #4F46E5;\n          background: rgba(79, 70, 229, 0.08);\n          z-index: 999999;\n          pointer-events: none;\n        }\n        \n        .fb-feedback-box {\n          position: absolute;\n          z-index: 1000000;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 10px 40px rgba(0,0,0,0.2);\n          padding: 20px;\n          width: 320px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          animation: fb-slide-in 0.3s ease-out;\n        }\n        \n        @keyframes fb-slide-in {\n          from { opacity: 0; transform: translateY(10px); }\n          to { opacity: 1; transform: translateY(0); }\n        }\n        \n        .fb-feedback-box-header {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          margin-bottom: 16px;\n        }\n        \n        .fb-feedback-box-title {\n          font-size: 16px;\n          font-weight: 600;\n          color: #1F2937;\n        }\n        \n        .fb-feedback-box-close {\n          background: none;\n          border: none;\n          font-size: 24px;\n          cursor: pointer;\n          color: #6B7280;\n          padding: 0;\n          width: 24px;\n          height: 24px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n        \n        .fb-comments-history {\n          max-height: 250px;\n          overflow-y: auto;\n          margin-bottom: 16px;\n          padding: 12px;\n          background: #F9FAFB;\n          border-radius: 8px;\n        }\n        \n        .fb-comment-item {\n          margin-bottom: 12px;\n          padding: 10px;\n          background: white;\n          border-radius: 6px;\n          border-left: 3px solid #4F46E5;\n        }\n        \n        .fb-comment-item:last-child {\n          margin-bottom: 0;\n        }\n        \n        .fb-comment-time {\n          font-size: 11px;\n          color: #6B7280;\n          margin-bottom: 6px;\n        }\n        \n        .fb-comment-text {\n          font-size: 14px;\n          color: #1F2937;\n          line-height: 1.5;\n          word-wrap: break-word;\n        }\n        \n        .fb-no-comments {\n          text-align: center;\n          color: #9CA3AF;\n          font-size: 13px;\n          padding: 20px;\n        }\n        \n        .fb-feedback-textarea {\n          width: 100%;\n          min-height: 80px;\n          padding: 12px;\n          border: 1px solid #D1D5DB;\n          border-radius: 8px;\n          font-family: inherit;\n          font-size: 14px;\n          resize: vertical;\n          box-sizing: border-box;\n        }\n        \n        .fb-feedback-textarea:focus {\n          outline: none;\n          border-color: #4F46E5;\n          box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);\n        }\n        \n        .fb-feedback-actions {\n          display: flex;\n          flex-wrap: wrap;\n          gap: 8px;\n          margin-top: 12px;\n        }\n        \n        .fb-feedback-btn {\n          flex: 1;\n          padding: 10px;\n          border: none;\n          border-radius: 6px;\n          font-size: 14px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.2s;\n          min-width: 0;\n        }\n        \n        .fb-feedback-btn.fb-feedback-btn-danger {\n          flex-basis: 100%;\n          order: 3;\n        }\n        \n        .fb-feedback-btn-primary {\n          background: #4F46E5;\n          color: white;\n        }\n        \n        .fb-feedback-btn-primary:hover {\n          background: #4338CA;\n        }\n        \n        .fb-feedback-btn-secondary {\n          background: #F3F4F6;\n          color: #374151;\n        }\n        \n        .fb-feedback-btn-secondary:hover {\n          background: #E5E7EB;\n        }\n        \n        .fb-feedback-btn-danger {\n          background: #EF4444;\n          color: white;\n          display: flex;\n          align-items: center;\n          gap: 4px;\n          justify-content: center;\n        }\n        \n        .fb-feedback-btn-danger:hover {\n          background: #DC2626;\n        }\n        \n        .fb-feedback-list {\n          position: fixed;\n          right: 20px;\n          top: 20px;\n          z-index: 999997;\n          background: white;\n          border-radius: 12px;\n          box-shadow: 0 10px 40px rgba(0,0,0,0.2);\n          padding: 16px;\n          width: 280px;\n          max-height: 400px;\n          overflow-y: auto;\n        }\n        \n        .fb-feedback-item {\n          padding: 12px;\n          background: #F9FAFB;\n          border-radius: 8px;\n          margin-bottom: 8px;\n          font-size: 13px;\n        }\n        \n        .fb-feedback-item-text {\n          color: #374151;\n          margin-bottom: 4px;\n        }\n        \n        .fb-feedback-item-meta {\n          color: #9CA3AF;\n          font-size: 11px;\n        }\n        \n        .fb-viewport-warning {\n          position: fixed;\n          top: 80px;\n          left: 50%;\n          transform: translateX(-50%);\n          z-index: 1000001;\n          max-width: 600px;\n          width: 90%;\n          animation: fb-slide-in 0.3s ease-out;\n        }\n        \n        .fb-viewport-warning-content {\n          background: white;\n          border: 2px solid #F59E0B;\n          border-radius: 16px;\n          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n          overflow: hidden;\n        }\n        \n        .fb-viewport-warning-header {\n          background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);\n          padding: 16px 20px;\n          display: flex;\n          align-items: center;\n          gap: 12px;\n          color: white;\n        }\n        \n        .fb-viewport-warning-header strong {\n          flex: 1;\n          font-size: 16px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        }\n        \n        .fb-viewport-warning-icon {\n          font-size: 24px;\n        }\n        \n        .fb-viewport-warning-body {\n          padding: 20px;\n        }\n        \n        .fb-viewport-metric {\n          margin-bottom: 20px;\n          padding-bottom: 20px;\n          border-bottom: 1px solid #E5E7EB;\n        }\n        \n        .fb-viewport-metric:last-of-type {\n          border-bottom: none;\n          margin-bottom: 0;\n          padding-bottom: 0;\n        }\n        \n        .fb-viewport-metric-label {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          font-weight: 600;\n          color: #374151;\n          margin-bottom: 12px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n        }\n        \n        .fb-viewport-metric-label .material-symbols-outlined {\n          font-size: 20px;\n          color: #6B7280;\n        }\n        \n        .fb-viewport-metric-values {\n          display: flex;\n          flex-direction: column;\n          gap: 8px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n          color: #6B7280;\n          padding-left: 28px;\n        }\n        \n        .fb-viewport-metric-values strong {\n          color: #111827;\n          font-family: 'Monaco', 'Courier New', monospace;\n        }\n        \n        .fb-status-badge {\n          display: inline-flex;\n          align-items: center;\n          justify-content: center;\n          width: 24px;\n          height: 24px;\n          border-radius: 50%;\n          font-weight: bold;\n          font-size: 14px;\n          margin-left: 8px;\n          transition: all 0.3s;\n        }\n        \n        .fb-status-badge.fb-status-ok {\n          background: #10B981;\n          color: white;\n        }\n        \n        .fb-status-badge.fb-status-error {\n          background: #EF4444;\n          color: white;\n        }\n        \n        .fb-viewport-warning-hint {\n          display: flex;\n          align-items: flex-start;\n          gap: 8px;\n          background: #F3F4F6;\n          padding: 12px;\n          border-radius: 8px;\n          font-size: 13px;\n          color: #6B7280;\n          line-height: 1.5;\n          margin-top: 16px;\n        }\n        \n        .fb-viewport-warning-hint .material-symbols-outlined {\n          font-size: 20px;\n          color: #9CA3AF;\n          flex-shrink: 0;\n        }\n      ",document.head.appendChild(e)},createToggleButton:function(){const e=document.createElement("div");e.className=`fb-widget-container ${this.config.buttonPosition}`;const t=document.createElement("div");t.className="fb-button-row";const n=document.createElement("button");n.className="fb-widget-button",n.innerHTML='<span class="material-symbols-outlined">chat</span><span>SyncVibes</span>',n.onclick=()=>this.toggleMode(),t.appendChild(n),this.toggleButton=n;const o=document.createElement("button");o.className="fb-widget-button fb-toggle-markers-btn",o.innerHTML=this.markersVisible?'<span class="material-symbols-outlined">visibility</span>':'<span class="material-symbols-outlined">visibility_off</span>',o.title=this.markersVisible?"Hide markers":"Show markers",o.onclick=()=>this.toggleMarkers(),t.appendChild(o),this.toggleMarkersButton=o,e.appendChild(t);const i=document.createElement("div");i.className="fb-stats-bar",i.innerHTML='\n        <div class="fb-stat-item">\n          <div class="fb-stat-number" id="fb-stat-page">0</div>\n          <div class="fb-stat-label">This Page</div>\n        </div>\n        <div class="fb-stat-item">\n          <div class="fb-stat-number" id="fb-stat-total">0</div>\n          <div class="fb-stat-label">Total</div>\n        </div>\n      ',e.appendChild(i),this.statsBar=i;const a=i.children[0],s=i.children[1];a.addEventListener("click",()=>{this.openAnnotationsModal("page")}),s.addEventListener("click",()=>{this.openAnnotationsModal("total")}),document.body.appendChild(e),this.widgetContainer=e,this.updateStats()},toggleMode:function(){if(this.isActive=!this.isActive,this.toggleButton.classList.toggle("active",this.isActive),this.toggleButton.innerHTML=this.isActive?'<span class="material-symbols-outlined">close</span><span>Close</span>':'<span class="material-symbols-outlined">chat</span><span>SyncVibes</span>',this.isActive&&!this.markersVisible){this.markersVisible=!0;document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display="block"}),this.toggleMarkersButton.innerHTML='<span class="material-symbols-outlined">visibility</span>',this.toggleMarkersButton.title="Hide markers",localStorage.setItem("feedback_markers_visible","true")}this.isActive?(document.body.style.cursor="crosshair",document.body.style.userSelect="none"):(document.body.style.cursor="",document.body.style.userSelect=""),!this.isActive&&this.currentBox&&this.closeCurrentBox()},toggleMarkers:function(){this.markersVisible=!this.markersVisible;document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display=this.markersVisible?"block":"none"}),this.toggleMarkersButton.innerHTML=this.markersVisible?'<span class="material-symbols-outlined">visibility</span>':'<span class="material-symbols-outlined">visibility_off</span>',this.toggleMarkersButton.title=this.markersVisible?"Hide markers":"Show markers",localStorage.setItem("feedback_markers_visible",this.markersVisible.toString())},updateStats:function(){const t=document.getElementById("fb-stat-page"),n=document.getElementById("fb-stat-total");if(!t||!n)return;const o=this.feedbacks.length,i=e.location.href,a=e.location.pathname,s=e.location.hash,r=this.feedbacks.filter(t=>{try{const n=new URL(t.url,e.location.origin);return t.url===i||(n.pathname===a&&n.hash===s||n.pathname===a&&!s&&!n.hash)}catch(e){return t.pathname===a}}).length;t.textContent=r,n.textContent=o},openAnnotationsModal:function(t){const n=e.location.href,o=e.location.pathname,i=e.location.hash;let a=[];a="page"===t?this.feedbacks.filter(t=>{try{const a=new URL(t.url,e.location.origin);return t.url===n||(a.pathname===o&&a.hash===i||a.pathname===o&&!i&&!a.hash)}catch(e){return t.pathname===o}}):this.feedbacks;const s=document.createElement("div");s.className="fb-modal-overlay";const r=document.createElement("div");r.className="fb-modal";const l=document.createElement("div");l.className="fb-modal-header";const c=document.createElement("div");c.className="fb-modal-title",c.innerHTML=`<span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 8px;">bookmark</span>${"page"===t?"This Page":"All"} Annotations (${a.length})`;const d=document.createElement("button");d.className="fb-modal-close",d.innerHTML='<span class="material-symbols-outlined">close</span>',d.title="Close",l.appendChild(c),l.appendChild(d);const b=document.createElement("div");b.className="fb-modal-body",0===a.length?b.innerHTML='\n          <div class="fb-empty-state">\n            <span class="material-symbols-outlined">sentiment_satisfied</span>\n            <div>No annotations yet</div>\n          </div>\n        ':a.forEach(t=>{const n=document.createElement("div");n.className="fb-annotation-item";let o="Unknown",i="";try{const n=new URL(t.url,e.location.origin);o=n.pathname,i=n.hash}catch(e){o=t.pathname||"Unknown"}n.innerHTML=`\n            <div class="fb-annotation-header">\n              <span class="material-symbols-outlined fb-annotation-icon">location_on</span>\n              <div class="fb-annotation-meta">\n                <div class="fb-annotation-page">${o}</div>\n                <div class="fb-annotation-location">${i||"Top of page"} â€¢ (${t.x}, ${t.y})</div>\n              </div>\n            </div>\n            <div class="fb-annotation-comment">${t.comment}</div>\n          `,n.addEventListener("click",()=>{this.navigateToAnnotation(t),this.closeModal(s)}),b.appendChild(n)}),r.appendChild(l),r.appendChild(b),s.appendChild(r),d.addEventListener("click",()=>this.closeModal(s)),s.addEventListener("click",e=>{e.target===s&&this.closeModal(s)}),document.body.appendChild(s)},closeModal:function(e){e.remove()},navigateToAnnotation:function(t){if(!this.markersVisible){this.markersVisible=!0;document.querySelectorAll(".fb-feedback-marker").forEach(e=>{e.style.display="block"}),this.toggleMarkersButton&&(this.toggleMarkersButton.innerHTML='<span class="material-symbols-outlined">visibility</span>',this.toggleMarkersButton.title="Hide markers"),localStorage.setItem("feedback_markers_visible","true")}const n=e.location.href;t.url!==n?(sessionStorage.setItem("fb_scroll_to_id",t.id),sessionStorage.setItem("fb_ensure_visible","true"),e.location.href=t.url):this.scrollToAnnotation(t)},scrollToAnnotation:function(t){const n=document.querySelector(`[data-feedback-id="${t.id}"]`);n?(n.style.display="block",n.scrollIntoView({behavior:"smooth",block:"center"}),n.style.animation="none",setTimeout(()=>{n.style.animation="pulse 1s ease-in-out 3"},10)):e.scrollTo({top:t.position.pageY-e.innerHeight/2,left:t.position.pageX-e.innerWidth/2,behavior:"smooth"})},setupEventListeners:function(){document.addEventListener("selectstart",e=>{this.isActive&&e.preventDefault()}),document.addEventListener("mousemove",e=>{this.isActive?(document.body.style.cursor="crosshair",document.body.style.userSelect="none",this.isDrawing&&this.currentDrawBox&&this.updateDrawingBox(e.pageX,e.pageY)):(document.body.style.cursor="",document.body.style.userSelect="")}),document.addEventListener("mousedown",e=>{this.isActive&&(e.target.closest(".fb-widget-button")||e.target.closest(".fb-feedback-box")||e.target.closest(".fb-feedback-marker")||(e.preventDefault(),e.stopPropagation(),this.startDrawing(e.pageX,e.pageY)))},!0),document.addEventListener("mouseup",e=>{this.isActive&&this.isDrawing&&(e.preventDefault(),e.stopPropagation(),this.finishDrawing(e.pageX,e.pageY))},!0)},setupRouteChangeListeners:function(){e.addEventListener("popstate",()=>{this.handleRouteChange()});const t=history.pushState,n=history.replaceState,o=this;let i;history.pushState=function(){t.apply(this,arguments),o.handleRouteChange()},history.replaceState=function(){n.apply(this,arguments),o.handleRouteChange()},e.addEventListener("hashchange",()=>{this.handleRouteChange()}),e.addEventListener("resize",()=>{clearTimeout(i),i=setTimeout(()=>{this.recheckViewportMismatch()},300)})},handleRouteChange:function(){console.log("Route changed to:",e.location.pathname),this.displayMarkersForCurrentPage(),this.currentBox&&this.closeCurrentBox(),this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null),this.isActive&&(this.isActive=!1,this.toggleButton.classList.remove("active"),this.toggleButton.textContent="ðŸ’¬ Feedback",document.body.style.cursor="",document.body.style.userSelect="")},startDrawing:function(e,t){this.isDrawing=!0,this.drawStartX=e,this.drawStartY=t;const n=document.createElement("div");n.className="fb-drawing-box",n.style.left=`${e}px`,n.style.top=`${t}px`,n.style.width="0px",n.style.height="0px",document.body.appendChild(n),this.currentDrawBox=n},updateDrawingBox:function(e,t){if(!this.currentDrawBox)return;const n=Math.min(this.drawStartX,e),o=Math.min(this.drawStartY,t),i=Math.abs(e-this.drawStartX),a=Math.abs(t-this.drawStartY);this.currentDrawBox.style.left=`${n}px`,this.currentDrawBox.style.top=`${o}px`,this.currentDrawBox.style.width=`${i}px`,this.currentDrawBox.style.height=`${a}px`},finishDrawing:function(e,t){this.isDrawing=!1;const n=Math.min(this.drawStartX,e),o=Math.min(this.drawStartY,t),i=Math.abs(e-this.drawStartX),a=Math.abs(t-this.drawStartY);if(i<10||a<10)return this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null),void this.createFeedbackBox(this.drawStartX,this.drawStartY,100,100);this.createFeedbackBox(n,o,i,a)},calculateBoxPosition:function(t,n,o,i,a,s){const r=20,l=e.innerWidth,c=e.innerHeight,d=e.scrollX,b=e.scrollY;let p,m;return p=t+o+10,m=n,p+a>l+d-r&&(p=t-a-10,p<d+r&&(p=Math.max(d+r,t+o/2-a/2))),p<d+r&&(p=d+r),m=n,m+s>c+b-r&&(m=n+i-s,m<b+r&&(m=c+b-s-r)),m<b+r&&(m=b+r),{left:p,top:m}},createFeedbackBox:function(e,t,n,o){this.closeCurrentBox();const i=document.createElement("div");i.className="fb-feedback-box",i.style.visibility="hidden",i.style.left="0px",i.style.top="0px",i.innerHTML=`\n        <div class="fb-feedback-box-header">\n          <div class="fb-feedback-box-title">Add Feedback</div>\n          <button class="fb-feedback-box-close">Ã—</button>\n        </div>\n        <textarea \n          class="fb-feedback-textarea" \n          placeholder="What's on your mind?"\n          maxlength="${this.config.maxCommentLength}"\n        ></textarea>\n        <div class="fb-feedback-actions">\n          <button class="fb-feedback-btn fb-feedback-btn-secondary">Cancel</button>\n          <button class="fb-feedback-btn fb-feedback-btn-primary">Save</button>\n        </div>\n      `,document.body.appendChild(i);const a=i.offsetWidth,s=i.offsetHeight,r=this.calculateBoxPosition(e,t,n,o,a,s);i.style.left=`${r.left}px`,i.style.top=`${r.top}px`,i.style.visibility="visible",this.currentBox={element:i,x:e,y:t,width:n,height:o};const l=i.querySelector(".fb-feedback-textarea");l.focus(),i.querySelector(".fb-feedback-box-close").onclick=()=>this.cancelFeedback(),i.querySelector(".fb-feedback-btn-secondary").onclick=()=>this.cancelFeedback(),i.querySelector(".fb-feedback-btn-primary").onclick=()=>this.saveFeedback(l.value,e,t,n,o);const c=e=>{"Escape"===e.key&&(this.cancelFeedback(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),i._escapeHandler=c},cancelFeedback:function(){this.closeCurrentBox(),this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null)},saveFeedback:function(t,n,o,i,a){if(!t.trim())return void alert("Please enter a comment");const s=this.generateId(),r=Date.now(),l={id:s,comment:t.trim(),comments:[{text:t.trim(),timestamp:r}],position:{x:n,y:o,width:i,height:a,pageX:n,pageY:o,viewportWidth:e.innerWidth,viewportHeight:e.innerHeight,scrollX:e.scrollX,scrollY:e.scrollY},url:e.location.href,pathname:e.location.pathname,timestamp:new Date(r).toISOString(),userAgent:navigator.userAgent,screenSize:{width:e.screen.width,height:e.screen.height}};this.feedbacks.push(l),this.saveFeedbacks(),this.currentDrawBox&&(this.currentDrawBox.remove(),this.currentDrawBox=null),this.createMarker(l),this.closeCurrentBox(),this.updateStats(),console.log("Feedback saved:",l)},createMarker:function(e){const t=document.createElement("div");t.className="fb-feedback-marker";const n=this.feedbacks.indexOf(e)+1;t.style.left=`${e.position.pageX}px`,t.style.top=`${e.position.pageY}px`,t.style.width=`${e.position.width}px`,t.style.height=`${e.position.height}px`,t.style.display=this.markersVisible?"block":"none",t.dataset.feedbackId=e.id;const o=document.createElement("div");o.className="fb-feedback-marker-label",o.textContent=n,t.appendChild(o),t.onclick=t=>{t.stopPropagation(),this.showFeedback(e)},document.body.appendChild(t),this.updateMarkerTooltip(e.id),console.log("Created marker #"+n+" at:",{left:t.style.left,top:t.style.top,width:t.style.width,height:t.style.height})},showFeedback:function(t){this.closeCurrentBox();const n=document.querySelector(`[data-feedback-id="${t.id}"]`);n&&n.classList.add("active");const o=document.createElement("div");o.className="fb-feedback-box",o.style.visibility="hidden",o.style.left="0px",o.style.top="0px";let i="";t.comments&&t.comments.length>0&&(i=t.comments.map(e=>`\n          <div class="fb-comment-item">\n            <div class="fb-comment-time">${new Date(e.timestamp).toLocaleString()}</div>\n            <div class="fb-comment-text">${this.escapeHtml(e.text)}</div>\n          </div>\n        `).join("")),o.innerHTML=`\n        <div class="fb-feedback-box-header">\n          <div class="fb-feedback-box-title">\n            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">chat</span>\n            Annotation #${this.feedbacks.indexOf(t)+1}\n          </div>\n          <button class="fb-feedback-box-close">Ã—</button>\n        </div>\n        <div class="fb-comments-history">\n          ${i||'<div class="fb-no-comments">No comments yet</div>'}\n        </div>\n        <textarea \n          class="fb-feedback-textarea" \n          placeholder="Add a comment..."\n          maxlength="${this.config.maxCommentLength}"\n        ></textarea>\n        <div class="fb-feedback-actions">\n          <button class="fb-feedback-btn fb-feedback-btn-danger">\n            <span class="material-symbols-outlined" style="font-size: 16px;">delete</span>\n            Delete\n          </button>\n          <button class="fb-feedback-btn fb-feedback-btn-secondary">Close</button>\n          <button class="fb-feedback-btn fb-feedback-btn-primary">Add Comment</button>\n        </div>\n      `,document.body.appendChild(o);const a=o.offsetWidth,s=o.offsetHeight;let r,l,c,d;if(n){const t=n.getBoundingClientRect();r=t.left+e.scrollX,l=t.top+e.scrollY,c=t.width,d=t.height}else r=t.position.pageX,l=t.position.pageY,c=t.position.width,d=t.position.height;const b=this.calculateBoxPosition(r,l,c,d,a,s);o.style.left=`${b.left}px`,o.style.top=`${b.top}px`,o.style.visibility="visible",this.currentBox={element:o,feedback:t,marker:n};const p=o.querySelector(".fb-feedback-textarea");p.focus(),o.querySelector(".fb-feedback-box-close").onclick=()=>this.closeCurrentBox(),o.querySelector(".fb-feedback-btn-secondary").onclick=()=>this.closeCurrentBox(),o.querySelector(".fb-feedback-btn-danger").onclick=()=>{confirm("Are you sure you want to delete this annotation and all its comments?")&&this.deleteAnnotation(t.id)},o.querySelector(".fb-feedback-btn-primary").onclick=()=>{const e=p.value.trim();e?(this.addCommentToFeedback(t.id,e),this.closeCurrentBox()):alert("Please enter a comment")};const m=e=>{"Escape"===e.key&&(this.closeCurrentBox(),document.removeEventListener("keydown",m))};document.addEventListener("keydown",m),o._escapeHandler=m},addCommentToFeedback:function(e,t){const n=this.feedbacks.find(t=>t.id===e);n&&(n.comments||(n.comments=[],n.comment&&n.comments.push({text:n.comment,timestamp:n.timestamp})),n.comments.push({text:t,timestamp:Date.now()}),this.saveFeedbacks(),this.updateMarkerTooltip(e),console.log("Added comment to feedback #"+e))},updateMarkerTooltip:function(e){const t=this.feedbacks.find(t=>t.id===e);if(!t)return;const n=document.querySelector(`[data-feedback-id="${e}"]`);if(!n)return;const o=(t.comments||(t.comment?[{text:t.comment,timestamp:t.timestamp}]:[])).map((e,t)=>`${t+1}. ${e.text} (${new Date(e.timestamp).toLocaleString()})`).join("\n\n");n.title=o||"No comments"},deleteAnnotation:function(e){const t=this.feedbacks.findIndex(t=>t.id===e);if(-1===t)return;this.feedbacks.splice(t,1);const n=document.querySelector(`[data-feedback-id="${e}"]`);n&&n.remove(),this.closeCurrentBox(),this.saveFeedbacks(),this.updateStats(),console.log("Deleted annotation #"+e)},escapeHtml:function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},closeCurrentBox:function(){this.currentBox&&(this.currentBox.element._escapeHandler&&document.removeEventListener("keydown",this.currentBox.element._escapeHandler),this.currentBox.marker&&this.currentBox.marker.classList.remove("active"),this.currentBox.element.remove(),this.currentBox=null)},saveFeedbacks:function(){try{localStorage.setItem(this.config.storageKey,JSON.stringify(this.feedbacks))}catch(e){console.error("Failed to save feedbacks:",e)}},loadFeedbacks:function(){try{const e=localStorage.getItem(this.config.storageKey);e&&(this.feedbacks=JSON.parse(e),this.displayMarkersForCurrentPage())}catch(e){console.error("Failed to load feedbacks:",e)}},displayMarkersForCurrentPage:function(){this.clearMarkers();const t=e.location.href,n=e.location.pathname,o=e.location.hash,i=this.feedbacks.filter(i=>{try{const a=new URL(i.url,e.location.origin);return i.url===t||(a.pathname===n&&a.hash===o||a.pathname===n&&!o&&!a.hash)}catch(e){return i.pathname===n}});i.forEach(e=>this.createMarker(e)),this.updateStats(),this.checkViewportMismatch(i),console.log(`Displayed ${i.length} markers for ${n}${o}`)},checkViewportMismatch:function(t){if(!t||0===t.length)return void this.hideViewportWarning();const n=t.map(e=>e.position).filter(e=>e&&e.viewportWidth&&e.viewportHeight);if(0===n.length)return void this.hideViewportWarning();const o=n[0],i=e.innerWidth,a=e.innerHeight,s=Math.abs(i-o.viewportWidth),r=Math.abs(a-o.viewportHeight);s>100||r>100?this.showViewportWarning(o.viewportWidth,o.viewportHeight):this.hideViewportWarning()},showViewportWarning:function(t,n){this.hideViewportWarning();const o=document.createElement("div");o.id="fb-viewport-warning",o.className="fb-viewport-warning",o.innerHTML=`\n        <div class="fb-viewport-warning-content">\n          <div class="fb-viewport-warning-header">\n            <span class="material-symbols-outlined fb-viewport-warning-icon">tune</span>\n            <strong>Display Mismatch Detected</strong>\n          </div>\n          <div class="fb-viewport-warning-body">\n            <div class="fb-viewport-metric">\n              <div class="fb-viewport-metric-label">\n                <span class="material-symbols-outlined">aspect_ratio</span>\n                Viewport Size\n              </div>\n              <div class="fb-viewport-metric-values">\n                <div>Expected: <strong>${t}Ã—${n}</strong></div>\n                <div>Current: <strong id="fb-current-viewport">${e.innerWidth}Ã—${e.innerHeight}</strong> <span id="fb-viewport-status" class="fb-status-badge fb-status-error">âœ—</span></div>\n              </div>\n            </div>\n            <div class="fb-viewport-metric">\n              <div class="fb-viewport-metric-label">\n                <span class="material-symbols-outlined">zoom_in</span>\n                Browser Zoom\n              </div>\n              <div class="fb-viewport-metric-values">\n                <div>Expected: <strong>100%</strong></div>\n                <div>Current: <strong id="fb-current-zoom">100%</strong> <span id="fb-zoom-status" class="fb-status-badge fb-status-ok">âœ“</span></div>\n              </div>\n            </div>\n            <div class="fb-viewport-metric">\n              <div class="fb-viewport-metric-label">\n                <span class="material-symbols-outlined">format_size</span>\n                Font Size\n              </div>\n              <div class="fb-viewport-metric-values">\n                <div>Expected: <strong>16px</strong></div>\n                <div>Current: <strong id="fb-current-fontsize">16px</strong> <span id="fb-fontsize-status" class="fb-status-badge fb-status-ok">âœ“</span></div>\n              </div>\n            </div>\n            <div class="fb-viewport-warning-hint">\n              <span class="material-symbols-outlined">info</span>\n              Adjust your window size and browser zoom to match the expected values. Indicators will turn green when fixed.\n            </div>\n          </div>\n        </div>\n      `,document.body.appendChild(o),this._originalViewport={width:t,height:n},this.startViewportMonitoring()},startViewportMonitoring:function(){this._viewportMonitorInterval&&clearInterval(this._viewportMonitorInterval),this._viewportMonitorInterval=setInterval(()=>{document.getElementById("fb-viewport-warning")?this.updateViewportMetrics():this.stopViewportMonitoring()},200)},stopViewportMonitoring:function(){this._viewportMonitorInterval&&(clearInterval(this._viewportMonitorInterval),this._viewportMonitorInterval=null)},updateViewportMetrics:function(){const t=document.getElementById("fb-current-viewport"),n=document.getElementById("fb-viewport-status"),o=document.getElementById("fb-current-zoom"),i=document.getElementById("fb-zoom-status"),a=document.getElementById("fb-current-fontsize"),s=document.getElementById("fb-fontsize-status");if(!t)return;const r=e.innerWidth,l=e.innerHeight;t.textContent=`${r}Ã—${l}`;const c=Math.abs(r-this._originalViewport.width)<=20&&Math.abs(l-this._originalViewport.height)<=20;n.textContent=c?"âœ“":"âœ—",n.className="fb-status-badge "+(c?"fb-status-ok":"fb-status-error");const d=Math.round(100*e.devicePixelRatio);o.textContent=`${d}%`;const b=100===d;i.textContent=b?"âœ“":"âœ—",i.className="fb-status-badge "+(b?"fb-status-ok":"fb-status-error");const p=parseFloat(getComputedStyle(document.documentElement).fontSize);a.textContent=`${Math.round(p)}px`;const m=Math.abs(p-16)<=2;s.textContent=m?"âœ“":"âœ—",s.className="fb-status-badge "+(m?"fb-status-ok":"fb-status-error"),c&&b&&m&&setTimeout(()=>{this.hideViewportWarning()},2e3)},recheckViewportMismatch:function(){const t=e.location.href,n=e.location.pathname,o=e.location.hash,i=this.feedbacks.filter(i=>{try{const a=new URL(i.url,e.location.origin);return i.url===t||(a.pathname===n&&a.hash===o||a.pathname===n&&!o&&!a.hash)}catch(e){return i.pathname===n}});i.length>0&&this.checkViewportMismatch(i)},hideViewportWarning:function(){this.stopViewportMonitoring();const e=document.getElementById("fb-viewport-warning");e&&e.remove()},clearMarkers:function(){document.querySelectorAll(".fb-feedback-marker").forEach(e=>e.remove())},exportFeedbacks:function(){return JSON.parse(JSON.stringify(this.feedbacks))},importFeedbacks:function(e){this.feedbacks=e,this.saveFeedbacks(),this.displayMarkersForCurrentPage()},clearFeedbacks:function(){confirm("Clear all feedbacks?")&&(this.feedbacks=[],this.saveFeedbacks(),this.clearMarkers(),this.updateStats())},generateId:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}};e.FeedbackWidget=t}(window);